#!/bin/bash
{% if container_manager != "containerd" %}
{{ docker_bin_dir }}/docker run -i --privileged --rm \
--net=host --pid=host \
-e ETCD_ENDPOINTS={{ etcd_access_addresses }} \
-e ETCD_CA_CERT_FILE={{ calico_cert_dir }}/ca_cert.crt \
-e ETCD_CERT_FILE={{ calico_cert_dir }}/cert.crt \
-e ETCD_KEY_FILE={{ calico_cert_dir }}/key.pem \
-v {{ docker_bin_dir }}/docker:{{ docker_bin_dir }}/docker \
-v /var/run/docker.sock:/var/run/docker.sock \
-v /var/run/calico:/var/run/calico \
-v {{ calico_cert_dir }}:{{ calico_cert_dir }}:ro \
--memory={{ calicoctl_memory_limit|regex_replace('Mi', 'M') }} --cpu-shares={{ calicoctl_cpu_limit|regex_replace('m', '') }} \
{{ calicoctl_image_repo }}:{{ calicoctl_image_tag}} \
"$@"
{% else %}
/usr/local/bin/ctr run --privileged --rm \
--net-host --with-ns pid:/proc/1/ns/pid \
--env ETCD_ENDPOINTS={{ etcd_access_addresses }} \
--env ETCD_CA_CERT_FILE={{ calico_cert_dir }}/ca_cert.crt \
--env ETCD_CERT_FILE={{ calico_cert_dir }}/cert.crt \
--env ETCD_KEY_FILE={{ calico_cert_dir }}/key.pem \
--mount type=bind,src=/usr/local/bin/ctr,dst=/usr/local/bin/ctr,options=rbind \
--mount type=bind,src=/run/containerd/containerd.sock,dst=/run/containerd/containerd.sock,options=rbind \
--mount type=bind,src=/var/run/calico,dst=/var/run/calico,options=rbind \
--mount type=bind,src={{ calico_cert_dir }},dst={{ calico_cert_dir }},options=rbind:ro \
{{ calicoctl_image_repo }}:{{ calicoctl_image_tag}} \
calicoctl \
/calicoctl \
"$@"
{% endif %}
